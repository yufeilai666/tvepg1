name: Update Logo List

on:
  push:
    paths:
      - 'logo/**'  # 监视所有分支的logo目录变化
  workflow_dispatch:  # 允许手动触发
    inputs:
      sort_method:
        description: '排序方法 (name, ascii, size, time)'
        required: false
        default: 'name'
      target_branch:
        description: '目标分支 (用于生成链接的分支)'
        required: false
        default: 'logo_info'

jobs:
  update-logo-list:
    # 只有当推送事件来自logo_info分支时才运行
    if: github.ref == 'refs/heads/logo_info' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Debug - Print event info
      run: |
        echo "事件名称: ${{ github.event_name }}"
        echo "触发分支: ${{ github.ref }}"
        echo "工作流SHA: ${{ github.sha }}"
        echo "触发者: ${{ github.actor }}"
        
    - name: Checkout logo_info branch
      uses: actions/checkout@v3
      with:
        ref: logo_info
        fetch-depth: 1

    - name: Checkout epg_scripts branch for script
      uses: actions/checkout@v3
      with:
        ref: epg_scripts
        path: epg_scripts
        fetch-depth: 1

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install pypinyin for Chinese sorting
      run: pip install pypinyin

    - name: Copy and run script to generate logo list
      run: |
        mkdir -p /tmp/script
        cp epg_scripts/update_logo_list.py /tmp/script/
        
        cd /tmp/script
        python update_logo_list.py
      env:
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF: ${{ github.ref }}
        SORT_METHOD: ${{ github.event.inputs.sort_method || 'name' }}
        TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'logo_info' }}
        LOGO_DIR: ${{ github.workspace }}/logo

    - name: Update README.md and logo.json in logo_info branch
      run: |
        cp /tmp/logo_list/README.md ./
        cp /tmp/logo_list/logo.json ./

    - name: Commit and push to logo_info branch
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md logo.json
        
        if git diff --staged --quiet; then
          echo "没有更改需要提交"
        else
          now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          git commit -m "Update logo list and JSON [skip ci]: $now_time"
          git push origin logo_info
        fi

    - name: Clean up
      run: |
        rm -rf /tmp/logo_list
        rm -rf /tmp/script
        echo "清理临时文件完成"